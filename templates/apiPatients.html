<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
	<meta charset="UTF-8">
	<title>í™˜ì ëª©ë¡</title>
	<link rel="stylesheet" href="../static/css/bootstrap.min.css"  th:href="@{/css/bootstrap.min.css}">
	<link rel="stylesheet" href="../static/css/base.css" th:href="@{/css/base.css}">
</head>
<body>
	<div class="search-container">
		<form th:action="@{/patients}" method="get" class="search-form">
			<input type="text"
			       name="searchName"
			       th:value="${param.searchName}"
			       placeholder="í™˜ì ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”"
			       class="search-input">
			<button type="submit" class="btn btn-info">ê²€ìƒ‰</button>
			<a th:href="@{/patients}" class="btn btn-link">ì´ˆê¸°í™”</a>
		</form>
	</div>

	<div class="row mt-2">
		<div class="col">
			<button onclick="openModal()" class="btn btn-primary float-end">í™˜ì ë“±ë¡</button>
		</div>
	</div>

	<table class="simple-table">
		<thead>
			<th>ID</th>
			<th>ì´ë¦„</th>
			<th>ìƒë…„ì›”ì¼</th>
			<th>ì„±ë³„</th>
			<th>ì„¤ëª…</th>
			<th>ìƒì„¸ë³´ê¸°</th>
		</thead>
		<tbody id="patient-list-body">
			<tr th:each="patient : ${patients}">
				<td th:text="${patient.id}"></td>
				<td>
					<a th:href="@{|/patients/${patient.id}|}" th:text="${patient.name}">í™ê¸¸ë™</a>
				</td>
				<td th:text="${patient.birth}"></td>
				<td th:text="${patient.gender}"></td>
				<td th:text="${patient.cn}"></td>
				<td>
					<a th:href="@{/patients/{id}(id=${patient.id})}" class="btn btn-info">ìƒì„¸ë³´ê¸°</a>
				</td>
			</tr>
			<tr th:if="${#lists.isEmpty(patients)}">
				<td colspan="6" style="text-align: center; padding: 50px 0; color: #888;">
					<p>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. ğŸ”</p>
					<a th:if="${param.searchName}" th:href="@{/patients}" style="text-decoration: underline;">ì „ì²´ ëª©ë¡ ë³´ê¸°</a>
				</td>
			</tr>
		</tbody>
	</table>

	<div id="pagination-wrapper" class="pagination-container">
    </div>

	<div id="modalOverlay" class="modal-overlay">
		<form class="simple-form" th:action="@{/patients}" th:object="${formData}" method="post">
			<div class="form-group">
				<label for="name">ì´ë¦„</label>
				<input type="text" id="name" placeholder="ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”." th:field="*{name}" th:errorclass="field-error" />
				<p class="error-text" th:errors="*{name}"></p>
			</div>
			<div class="form-group">
				<label for="birth">ìƒë…„ì›”ì¼</label>
				<input type="text" id="birth" placeholder="ìƒë…„ì›”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”." th:field="*{birth}" th:errorclass="field-error" />
				<p class="error-text" th:errors="*{birth}"></p>
			</div>
			<p class="label-title">ì„±ë³„</p>
			<div class="gender-group">
				<input type="radio" id="male" name="gender" value="male" th:field="*{gender}" checked>
				<label for="male">ë‚¨ì„±</label>

				<input type="radio" id="female" name="gender" value="female" th:field="*{gender}">
				<label for="female">ì—¬ì„±</label>

				<input type="radio" id="other" name="gender" value="other" th:field="*{gender}">
				<label for="other">ê¸°íƒ€</label>
			</div>
			<p class="error-text" th:errors="*{gender}"></p>
			<div class="form-group">
				<label for="cn">ë¹„ê³ </label>
				<textarea id="cn" placeholder="ë¹„ê³  ì…ë ¥í•´ì£¼ì„¸ìš”." rows="4" th:field="*{cn}" ></textarea>
				<p class="error-text" th:errors="*{cn}"></p>
			</div>
			<div class="form-group">
				<label for="imageFile">í™˜ì ì‚¬ì§„</label>
				<input type="file" id="imageFile" name="imageFile" class="form-control" accept="image/*">
			</div>

			<div class="button-group">
				<button type="button" class="close-btn" onclick="closeModal()">ì·¨ì†Œ</button>
				<button type="submit" class="submit-btn">ì €ì¥</button>
			</div>
		</form>
	</div>
	

	<script th:inline="javascript">
		window.onload = function() {
			// ì„œë²„ì—ì„œ ë³´ë‚¸ hasError ê°’ì´ trueì¸ì§€ í™•ì¸
			//let hasError = [[${hasError}]] || false;
			const searchInput = document.querySelector('.search-input');
			const val = searchInput.value;
			//ê°’ì´ ìˆì„ ë•Œë§Œ í¬ì»¤ìŠ¤ë¥¼ ì¤ë‹ˆë‹¤.
			if (val) {
				searchInput.focus();
				searchInput.value = '';
				searchInput.value = val;
			}

			loadPage(0);

			// if(hasError) {
			// 	openModal();
			// }
		}

		const modal = document.getElementById("modalOverlay");
		// ëª¨ë‹¬ ì—´ê¸°
		function openModal() {
			modal.style.display = 'flex';
		}
		// ëª¨ë‹¬ ë‹«ê¸°
		function closeModal() {
			modal.style.display = 'none';
		}
		
		window.onclick = function(event) {
			if (event.target == modal) {}
		}

		//ì…ë ¥í•  ë•Œë§ˆë‹¤ 0.5ì´ˆ ë’¤ì— ìë™ìœ¼ë¡œ ê²€ìƒ‰ í¼ì„ ì „ì†¡í•˜ëŠ” ì˜ˆì‹œ (ë””ë°”ìš´ì‹±)
		// let timer;
		// document.querySelector('.search-input').addEventListener('input', function() {
		// 	clearTimeout(timer);
		// 	timer = setTimeout(() => {
		// 	 document.querySelector('.search-form').submit();
		// 	loadPage(0);
		// 	}, 500); // 0.5ì´ˆ ë™ì•ˆ ì…ë ¥ì´ ì—†ìœ¼ë©´ ê²€ìƒ‰ ì‹¤í–‰
		// });

		function loadPage(pageNumber) {
			// console.log(pageNumber);

			// í˜„ì¬ ê²€ìƒ‰ì–´ ê°€ì ¸ì˜¤ê¸°
			const searchName = document.querySelector('.search-input').value
			// console.log(searchName);

			// 1.Fetch í˜¸ì¶œ
			fetch(`http://localhost:8080/api/patients?page=${pageNumber}&searchName=${searchName}`)
				.then(response => response.json())
				.then(data => {
					// 1. í…Œì´ë¸” ë³¸ë¬¸ ì—…ë°ì´íŠ¸
					renderTable(data.content);
					// 2. í˜ì´ì§• ë²„íŠ¼ ì—…ë°ì´íŠ¸
					updatePaginationUI(data);
				})
				.catch(error => console.error('Error:', error));
		}

		function renderTable(data) {
			// 1.í…Œì´ë¸” ë³¸ë¬¸ ë¹„ìš°ê¸°
			const tbody = document.getElementById('patient-list-body');
			tbody.innerHTML = '';

			// 2. ë°ì´í„°ë¥¼ ë°˜ë³µí•´ì„œ ìƒˆë¡œìš´ í–‰(tr) ì¶”ê°€
			data.forEach(p => {
				const row = `
						<tr>
							<td>${p.id}</td>
							<td><a href="/patients/${p.id}">${p.name}</a></td>
							<td>${p.birth}</td>
							<td>${p.gender === 'male' ? 'ë‚¨ì„±' : 'ì—¬ì„±'}</td>
							<td>${p.cn || ''}</td>
						</tr>
				`;
				tbody.insertAdjacentHTML('beforeend', row);
			});
		}

		function updatePaginationUI(data) {
			const wrapper = document.getElementById('pagination-wrapper');
			wrapper.innerHTML = '';

			const { totalPages, number, first, last } = data; //êµ¬ì¡°ì  ë¶„í•´ í• ë‹¹ ì‚¬ìš©
			const searchName = document.querySelector('.search-input').value;

			const windowSize = 2;
			const start = Math.max(0, number - windowSize); //í˜„ì¬ í˜ì´ì§€ ë²ˆí˜¸ - ìœˆë„ìš° ì‚¬ì´ì¦ˆ
			const end = Math.min(totalPages - 1, number + windowSize);

			const ul = document.createElement('ul');
			ul.className = 'pagination';

			// 2. 'ì´ì „' ë²„íŠ¼ ìƒì„±
			const prevLi = document.createElement('li');
			prevLi.className = `page-item ${first ? 'disabled' : ''}`;
			prevLi.innerHTML = `<a class="page-link" href="javascript:void(0);">ì´ì „</a>`;
			if(!first) {
				prevLi.onclick = () => loadPage(number - 1); // í´ë¦­ ì‹œ ì´ì „ í˜ì´ì§€ í˜¸ì¶œ
			}
			ul.appendChild(prevLi);

			// 3. 'í˜ì´ì§€ ë²ˆí˜¸ ë²„íŠ¼ ìƒì„±'
			for(let i = start; i <= end; i++) {
				const li = document.createElement('li');
				li.className = `page-item ${i === number ? 'active' : ''}`;
        li.innerHTML = `<a class="page-link" href="javascript:void(0);">${i + 1}</a>`;

				li.onclick = () => {
					if(i !== number) loadPage(i);
				}
				ul.appendChild(li);
			}

			// 4. 'ë‹¤ìŒ' ë²„íŠ¼ ìƒì„±
			const nextLi = document.createElement('l1');
			nextLi.className = `page-item ${last ? 'disabled' : ''}`;
			nextLi.innerHTML = `<a class="page-link" href="javascript:void(0);">ë‹¤ìŒ</a>`;
			if(!last) {
				nextLi.onclick = () => loadPage(number + 1);
			}
			ul.appendChild(nextLi);

			// ìµœì¢…ì ìœ¼ë¡œ í™”ë©´ì— ë¶™ì´ê¸°
    	wrapper.appendChild(ul);

		}

	</script>
</body>
</html>