<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
	<meta charset="UTF-8">
	<title>환자 목록</title>
	<link rel="stylesheet" href="../static/css/bootstrap.min.css"  th:href="@{/css/bootstrap.min.css}">
	<link rel="stylesheet" href="../static/css/base.css" th:href="@{/css/base.css}">
</head>
<body>
	

  <div id="app" class="container">
		<h2>환자 목록 (Vue.js 버전)</h2>

		<div class="search-filter-container" style="display: flex; gap: 10px; margin-bottom: 20px;">
			<input type="text" class="search-input-name" v-model="searchCond.name" @input="onSearch" placeholder="이름 검색...">

			<select v-model="searchCond.gender" @change="onSearch" class="form-select">
				<option value="">성별 전체</option>
				<option value="male">남성</option>
				<option value="female">여성</option>
			</select>

			<input type="date" class="date-input" v-model="searchCond.startDate" @change="onSearch">
			<span>~</span>
			<input type="date" class="date-input" v-model="searchCond.endDate" @change="onSearch">

			<button @click="resetFilters" class="btn btn-reset">초기화</button>
		</div>

		<div class="table-container">
			<table class="custom-table">
				<thead>
					<tr>
						<th>ID</th><th>이름</th><th>생년월일</th><th>성별</th><th>설명</th>
						<!-- <th>상세보기</th>	 -->
					</tr>
				</thead>
				<tbody>
					<tr v-for="p in patients" :key="p.id">
						<td>{{ p.id }}</td>
						<td><a href="javascript:void(0);" @click="showDetail(p.id)">{{ p.name }}</a></td>
						<!-- <td><a @click="showDetail(p.id)">{{ p.name }}</a></td> -->
						<td>{{ p.birth }}</td>
						<td v-if="p.gender === 'male'"><span class="badge badge-male">남성</span></td>
						<td v-else><span class="badge badge-female">여성</span></td>
						<td>{{ p.cn }}</td>
						<!-- <td>서비스 준비 중</td> -->
					</tr>
					<tr v-if="patients.length === 0">
						<td colspan="4">검색 결과가 없습니다.</td>
					</tr>
				</tbody>
			</table>
		</div>

		

		<nav class="pagination-container">
        <ul class="pagination">
						<li class="page-item" :class="{ disabled: isFirst }">
                <a class="page-link" @click="!isFirst && loadPage(0)">&lt;&lt;</a>
            </li>

            <li class="page-item" :class="{ disabled: isFirst }">
                <a class="page-link" @click="!isFirst && loadPage(currentPage - 1)">이전</a>
            </li>

            <li class="page-item" v-for="idx in pageNumbers" :key="idx" :class="{ active: idx === currentPage }">
                <a class="page-link" @click="loadPage(idx)">{{ idx + 1 }}</a>
            </li>

            <li class="page-item" :class="{ disabled: isLast }">
                <a class="page-link" @click="!isLast && loadPage(currentPage + 1)">다음</a>
            </li>

						<li class="page-item" :class="{ disabled: isLast }">
                <a class="page-link" @click="!isLast && loadPage(totalPages - 1)">&gt;&gt;</a>
            </li>
        </ul>
    </nav>

		<div v-if="showModal" class="modal-overlay" @click.self="closeModal">
			<div class="modal-content">
				<div class="modal-header">
						<h3>환자 상세 정보</h3>
						<button class="close-btn" @click="closeModal">❌</button>
				</div>
				<div class="modal-body" v-if="selectedPatient">
						<div class="info-group">
							<label class="info-label">이름:</label>
							<span v-if="!isEditing">{{ selectedPatient.name }}</span>
							<input v-else v-model="editForm.name" class="form-control">
						</div>

						<div class="info-group">
							<label class="info-label">생년월일:</label>
							<span v-if="!isEditing">{{ selectedPatient.birth }}</span>
							<input v-else v-model="editForm.birth" class="form-control">
						</div>

						<div class="info-group">
							<label class="info-label">성별:</label>
							<span v-if="!isEditing">{{ selectedPatient.gender === 'male' ? '남성' : '여성' }}</span>
							<input v-else v-model="editForm.gender" class="form-control">
						</div>

						<div class="info-group">
							<label class="info-label">비고:</label>
							<span v-if="!isEditing">{{ selectedPatient.cn }}</span>
							<textarea v-else v-model="editForm.cn" class="form-control"></textarea>
						</div>

						<div class="info-group">
							<label class="info-label">메모:</label>
							<textarea v-model="newMemoContent" class="form-control"></textarea>
							<button @click="addMemo" class="btn btn-sm btn-primary mt-2">메모 저장</button>
						</div>

						<div class="memo-list" style="max-height: 200px; overflow-y: auto;">
							<label class="info-label">이전 메모 내역:</label>
							<div v-for="m in selectedPatient.memos" :key="m.id" class="memo-item" style="border-bottom: 1px solid #eee; padding: 5px 0;">
									<small class="text-muted">{{ m.createdDate }}</small>
									<p style="margin: 0;">{{ m.content }}</p>
									<button @click="editMemo(m.id, m.content)" class="btn btn-link btn-sm">수정</button>
									<button @click="removeMemo(m.id)" class="btn btn-danger btn-sm">삭제</button>
							</div>
							<div v-if="!selectedPatient.memos || selectedPatient.memos.length === 0" class="text-center text-muted">
									작성된 메모가 없습니다.
							</div>
						</div>

						<div class="info-group" v-if="isEditing">
							<label>환자 사진:</label>
							<input type="file" ref="fileInput" @change="handleFileChange" class="form-control">
						</div>
							
						<div class="info-group" v-if="isEditing">
								<div v-if="imagePreview" style="margin-top: 10px;">
									<img :src="imagePreview" style="width: 100%; max-height: 100px; object-fit: contain;">
								</div>
						</div>

						<div v-if="selectedPatient.storedFileName && !isEditing" style="margin-top: 10px;">
								<img :src="'http://localhost:8080/images/' + selectedPatient.storedFileName" width="100%" height="200px">
						</div>
				</div>
				<div class="modal-footer" style="margin-top: 20px; text-align: right;">
					

					<div v-if="!isEditing">
							<button @click="deletePatient" class="btn btn-danger">삭제</button>
							<button @click="startEdit" class="btn btn-primary">수정</button>
							<button @click="closeModal" class="btn btn-secondary">닫기</button>
					</div>	

					<div v-else>
						<button @click="saveUpdate" class="btn btn-success">저장</button>
            <button @click="cancelEdit" class="btn btn-secondary">취소</button>
					</div>
				</div>
			</div>
		</div>
	 </div>

	<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
	<script>
		const { createApp } = Vue;
		createApp({
			data() {
				return {
					patients: [],      // 서버에서 받은 환자 리스트
					searchName: '',    // 검색어
					currentPage: 0,    // 현재 페이지 번호
					totalPages: 0,     // 전체 페이지 수
					isFirst: true,     // 첫 페이지 여부
					isLast: false,     // 마지막 페이지 여부
					windowSize: 2,      // 페이징 윈도우 크기
					showModal: false,		// 모달 표시 여부
					selectedPatient: null, // 선택된 환자의 상세 데이터
					editForm: null,        // 수정용 복사본 데이터
					isEditing: false, // 현재 수정 모드인지 여부
					selectedFile: null,  // 선택된 파일 객체
        	imagePreview: null,   // 미리보기용 URL
					searchCond: this.getInitialSearchCond(), //초기값 설정
					newMemoContent: null, //메모 내용 저장
				}
			},
			computed: {
				// [윈도우 페이징 로직] 계산된 속성을 쓰면 HTML이 훨씬 깔끔해집니다.
        pageNumbers() {
            let start = Math.max(0, this.currentPage - this.windowSize);
            let end = Math.min(this.totalPages - 1, this.currentPage + this.windowSize);
            let pages = [];
            for (let i = start; i <= end; i++) pages.push(i);
            return pages;
        }
			},
			methods: {
				//초기 검색 조건을 반환하는 함수
				getInitialSearchCond() {
					const date = new Date();
					
					const year = date.getFullYear();
					// const month = String(date.getMonth() + 1).padStart(2,'0');
					// const day = String(date.getDate()).padStart(2,'0');

					// const startDate = `${year}-01-01`;
					const startDate = `2001-12-31`;
					const endDate = `${year}-12-31`;

					return {
						name: '',
						gender: '',
						startDate: startDate,
						endDate: endDate,
					}
				},
				
				async editMemo(memoId, oldContent) {
					console.log(memoId);
					console.log(oldContent);

					const newContent = prompt("메모를 수정하세요:", oldContent);

					//사용자가 취소를 누르거나 빈 값을 입력했을 때 처리
					if (newContent === null) return;
					if (newContent.trim() === "") return alert("내용을 입력해주세요.");
					if (newContent === oldContent) return;

					try {
						const response = await fetch(`http://localhost:8080/api/memos/${memoId}`, {
							method: "PUT",
							headers: {'Content-Type' : 'application/json'},
							body: JSON.stringify({ content: newContent})
						});

						if (response.ok) {
							alert("수정되었습니다.");
							const updatedDetail = await response.json();
							this.selectedPatient = updatedDetail;
						}

					} catch(error) {
						console.error("수정 실패:", error);
					}
				},

				resetFilters() {
					//객체 전체를 초기화 함수 결과값으로 교체
					this.searchCond = this.getInitialSearchCond();

					//초기화 후 첫 페이지 목록을 다시 불러옴
					this.onSearch();
				},

				async addMemo() {
					if(!this.newMemoContent) return alert("내용을 입력하세요.");

					try {
						const response = await fetch(`http://localhost:8080/api/patients/${this.selectedPatient.id}/memos`, {
							method: "POST",
							headers: {'Content-Type' : 'application/json'},
							body: JSON.stringify({ content: this.newMemoContent }) // 객체 형태로 보내는 것 권장
						});

						if(response.ok) {
							alert("저장되었습니다");
							const updatedDetail = await response.json();
							// 환자 정보와 메모 리스트가 한꺼번에 갱신됨!
							this.selectedPatient = updatedDetail; 
							this.newMemoContent = '';
						} else {
							new Error("메모 저장 중 에러 발생");
						}

					} catch (error) {
						console.error(error);
					}
				},

				async removeMemo(memoId) {
					if(!confirm("현재 메모를 삭제하시겠습니까?")) {
						return;
					}

					try {
						const response = await fetch(`http://localhost:8080/api/memos/${memoId}`, {
							method: "DELETE",
						})


						if(response.ok) {
							alert("삭제되었습니다.");
							const updatedDetail = await response.json();
							this.selectedPatient = updatedDetail;
						}

					} catch(error) {
						console.error(error);
					}
					
				},


				// 검색 조건이 바뀔 때마다 호출
				async onSearch() {
					this.currentPage = 0; //검색 시 첫 페이지로 리셋
					await this.loadPage(0);
				},

				async loadPage(pageNumber) {
					//1. searchCon의 복사본 filter 작성
					const filter = { ...this.searchCond }

					//2.날짜형식 데이터 하이픈(-) 제거
					if (filter.startDate) filter.startDate = filter.startDate.replace(/-/g, '');
					if (filter.endDate) filter.endDate = filter.endDate.replace(/-/g, '');

					const params = new URLSearchParams({
						page: pageNumber,
						...filter //객체 전개 연산자로 name, gender 등을 한꺼번에 포함
					});
					
					try {
                const response = await fetch(`http://localhost:8080/api/patients?${params.toString()}`);
                const data = await response.json();

                // 데이터를 갈아끼우기만 하면 화면은 Vue가 알아서 다시 그립니다 (반응성)
                this.patients = data.content;
                this.totalPages = data.totalPages;
                this.currentPage = data.number;
                this.isFirst = data.first;
                this.isLast = data.last;
            } catch (error) {
                console.error("데이터 로딩 실패:", error);
            }
				},
				async showDetail(id) {
					try {
						const response = await fetch(`http://localhost:8080/api/patients/${id}`);
						
						// response.ok가 false면 (4xx, 5xx 에러인 경우)
						if (!response.ok) {
								// 서버가 보낸 에러 JSON을 읽음
								const errorData = await response.json();
								throw new Error(errorData.message || "데이터를 가져오는 중 오류가 발생했습니다.");
						}

						const data = await response.json();
						this.selectedPatient = data;
						this.tempPatient = data;
						this.showModal = true;
					} catch (error) {
						alert(error.message);
					}
				},

				handleFileChange(event) {
					this.selectedFile = event.target.files[0];
					if(this.selectedFile) {
						this.imagePreview = URL.createObjectURL(this.selectedFile);
					}
				},

				async saveUpdate() {
					const blob = new Blob([JSON.stringify(this.editForm)], {type: 'application/json'}); // JSON 타입의 Blob 생성
					
					const formData = new FormData();
					formData.append('patient', blob); // "patient"라는 이름의 JSON 파일처럼 주입

					if(this.selectedFile) {
						formData.append('file', this.selectedFile); //실제 이미지 파일 주입
					}

					try {
						const response = await fetch(`http://localhost:8080/api/patients/${this.editForm.id}`, {
							method: 'PUT',
							// headers: { 'Content-Type' : 'application/json'},
							// body: JSON.stringify(this.editForm),
							body: formData
						});

						if (response.ok) {
							alert("정보가 수정되었습니다.");
							// 1. 원본 데이터를 수정본으로 교체 (화면 갱신)
							this.selectedPatient = JSON.parse(JSON.stringify(this.editForm));
							// 2. 수정 모드 종료
							this.isEditing = false;
							this.selectedFile = null;
							this.imagePreview = null;	
							// 3. (필요 시) 메인 리스트 재로딩
							this.loadPage(this.currentPage);
							this.showDetail(this.editForm.id);
						} else {
								alert("수정에 실패했습니다.");
						}

					} catch (error) {
						console.error("수정 실패:", error);
					}
				},
				async deletePatient() {
					// 1. 사용자 확인 (Confirm)
					if (!confirm(`정말로 ${this.selectedPatient.name} 환자의 정보를 삭제하시겠습니까?`)) {
						return;
					}

					try {
						// 2. 삭제 API 호출 (DELETE 방식)
						const response = await fetch(`http://localhost:8080/api/patients/${this.selectedPatient.id}`, {
								method: 'DELETE'
						});

						if (response.ok) {
								alert("삭제되었습니다.");
								this.closeModal(); // 모달 닫기
								this.loadPage(this.currentPage); // 현재 페이지 목록 새로고침
						} else {
								alert("삭제에 실패했습니다.");
						}
					} catch (error) {
							console.error("삭제 중 오류 발생:", error);
					}
				},

				startEdit() {
					// 원본 데이터를 복사하여 수정용 폼에 할당 (깊은 복사)
					this.editForm = JSON.parse(JSON.stringify(this.selectedPatient));
					this.isEditing = true;
				},

				cancelEdit() {
					this.editForm = null;
        	this.isEditing = false;
				},

				closeModal() {
					this.showModal = false;
					this.selectedPatient = null;
					this.isEditing = false;
				}

			},
			mounted() {
				this.loadPage(0);
			} 
		}).mount('#app')
	</script>

</body>
</html>